IF (SELECT TOP 1 value FROM sys.configurations WHERE name = 'clr enabled') != 1
BEGIN
    EXEC sp_configure 'clr enabled', 1
    RECONFIGURE
END
DECLARE @sql nvarchar(MAX), @hash varbinary(64)
DECLARE @clrBinary varbinary(MAX) = 0x4D5A90000300000004000000FFFF0000B800000000000000400000000000000000000000000000000000000000000000000000000000000000000000800000000E1FBA0E00B409CD21B8014CCD21546869732070726F6772616D2063616E6E6F742062652072756E20696E20444F53206D6F64652E0D0D0A2400000000000000504500004C0103004777F2660000000000000000E00022200B013000001000000006000000000000EE2E00000020000000400000000000100020000000020000040000000000000006000000000000000080000000020000000000000300608500001000001000000000100000100000000000001000000000000000000000009C2E00004F000000004000009802000000000000000000000000000000000000006000000C000000642D00001C0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000200000080000000000000000000000082000004800000000000000000000002E74657874000000F40E0000002000000010000000020000000000000000000000000000200000602E7273726300000098020000004000000004000000120000000000000000000000000000400000402E72656C6F6300000C0000000060000000020000001600000000000000000000000000004000004200000000000000000000000000000000D02E0000000000004800000002000500E82500007C0700000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000720002730500000A7D01000004022300000000801CC8407D020000042A00000013300400F400000001000011000F02280600000A2D2E0F01280700000A2D250F01230000000000000000280800000A8C09000001FE16090000016F0900000A16FE012B01160A06398E0000000004280A00000A280B00000A280C00000A0C1202280D00000A0B027B01000004078C110000016F0E00000A15FE010D092C20027B01000004078C1100000103280F00000A6C8C120000016F1000000A002B3B00027B01000004078C110000016F1100000AA5120000011304027B01000004078C11000001110403280F00000A6C588C120000016F1200000A000000027B020000042300000000801CC840FE01130511052C0E020F03281300000A6C7D020000042A13300500C5000000020000110002037B020000047D02000004037B010000040A066F1400000A0B066F1500000A0C160D388900000000027B0100000407096F1600000A6F0E00000A15FE01130411042C26027B0100000407096F1600000A08096F1600000AA5120000018C120000016F1000000A002B4200027B0100000407096F1600000A6F1100000AA5120000011305027B0100000407096F1600000A110508096F1600000AA512000001588C120000016F1200000A0000000917580D09066F1700000AFE04130611063A65FFFFFF2A00000013300300C90000000300001100027B010000046F1400000A0A027B010000046F1500000A0B170C170D1613042B48000711046F1600000AA512000001230000000000000000FE02130611062C02160C0711046F1600000AA512000001230000000000000000FE04130711072C02160D110417581304001104076F1800000A2F050809602B0116130811082DA2080960130911092C0A007E1900000A130A2B33000706027B02000004280700000613051105281A00000A130B110B2C0A007E1900000A130A2B0C001105731B00000A130A2B00110A2A0000001330030054000000040000110002036F1C00000A7D0200000402730500000A7D01000004036F1D00000A0A160B2B2800027B01000004036F1D00000A8C11000001036F1C00000A8C120000016F1000000A00000717580B0706FE040C082DD02A133003007B000000050000110003027B020000046F1E00000A0003027B010000046F1700000A6F1F00000A00027B010000046F1400000A0A027B010000046F1500000A0B160C2B2C000306086F1600000AA5110000016F1F00000A000307086F1600000AA5120000016F1E00000A00000817580C08027B010000046F1700000AFE040D092DC22A0013300400D60100000600001100040A2348AFBC9AF2D77A3E0B1F640C2300000000000000000D230000000000000000130423CB1A50CAFFFFEFBF13051613063880010000002300000000000000000D230000000000000000130416130838BC000000000311086F1600000AA51100000103166F1600000AA511000001596C230000000000D076405B13090623000000000000F03F58130A110A230000000000000000FE0316FE01130C110C2C110023000000000000F8FF130D3821010000110A1109282000000A130B110B230000000000000000FE01130E110E2C0D0023BBBDD7D9DF7CDB3D130B00090211086F1600000AA512000001110B5B580D110411090211086F1600000AA5120000015A110B110A5A5B591304001108175813081108026F1800000AFE04130F110F3A31FFFFFF09282100000A07FE04131011102C090006130D38960000001104230000000000000000FE01131111112C0E0023000000000000F8FF130D2B75060911045B5913071107281A00000A2D091107282200000A2B0117131211122C0E0023000000000000F8FF130D2B4611071105FE0316FE01131311132C1200061105582300000000000000405B13070011070A11061758130600110608FE04131411143A72FEFFFF23000000000000F8FF130D2B00110D2A000042534A4201000100000000000C00000076342E302E33303331390000000005006C000000CC020000237E000038030000F002000023537472696E6773000000002806000004000000235553002C0600001000000023475549440000003C0600004001000023426C6F620000000000000002000001571502000902000000FA013300160000010000001400000003000000020000000700000009000000220000000400000006000000010000000200000001000000000022010100000000000600D500DA010600F500DA010600A000C7010F00FA0100000A006D0293010A00B400930106007B0048010600A80232020A00650009020A006F00090206004F0148010600A2023202060079011A00060086011A0006007402480106007200480106000500480106006800480106006701320206001D014801000000000B00000000000100010009211000240000001D000100010082011000AE0100003D000300070006004B02D40006004502D800502000000000860093020600010070200000000086008500DB00010070210000000086005400E500040044220000000086009000EB0005001C230000000086004B00F00005007C230000000086009A00F600060004240000000096002900FC000700000001005702000002001E0200000300450200000100730100000100C10100000100CD020000010024020000020068020000030045020900BD0101001100BD0106001900BD010A003100BD0110004100BD01060051002B01200049002B01200049007B02240079002B022A00510087022F008100CF023600810058013B0059005F0244004100D9024800490087024D0041005000530041003601590041003F015300490013015E004100C0026F004100B3026F00610036017400410098024400990098024400490031018B00910014008F004900BD01940069005A005E0069000100440071009A00940071009A000100A100CB02C000A100C301C6009100E4028F002E000B0005012E0013000E012E001B002D0143002300360116006200790099009F00A80004800000000000000000000000000000000024000000040000000000000000000000CB00420000000000040000000000000000000000CB003600000000000300020000000052656164496E743332003C4D6F64756C653E0049734E614E0053797374656D2E494F00584952520063616C63756C6174654952520053797374656D2E44617461006D73636F726C6962005265616400416464004D657267650052656164446F75626C650053716C446F75626C650053716C4461746554696D650056616C75655479706500416363756D756C617465005465726D696E6174650057726974650044656275676761626C654174747269627574650053716C55736572446566696E656441676772656761746541747472696275746500436F6D70696C6174696F6E52656C61786174696F6E734174747269627574650052756E74696D65436F6D7061746962696C697479417474726962757465006765745F56616C7565004D61746800584952522E646C6C006765745F49734E756C6C006765745F4974656D007365745F4974656D0053797374656D0054696D655370616E006F705F5375627472616374696F6E0049436F6C6C656374696F6E0047726F75700042696E6172795265616465720042696E617279577269746572004D6963726F736F66742E53716C5365727665722E536572766572005869727243616C63756C61746F72002E63746F72004162730053797374656D2E446961676E6F73746963730053797374656D2E52756E74696D652E436F6D70696C6572536572766963657300446562756767696E674D6F6465730053797374656D2E446174612E53716C54797065730064617465730076616C75657300457175616C730053797374656D2E436F6C6C656374696F6E7300677565737300697272456C656D656E747300616D6F756E7473006765745F44617973006461797300466F726D6174004F626A656374006F705F496D706C69636974006F705F4578706C6963697400496E6974006765745F436F756E7400494C69737400536F727465644C6973740047657456616C75654C697374004765744B65794C69737400506F77006765745F546F64617900496E6465784F664B6579004973496E66696E697479000000000000F5CC80CF9DBBA644ACD31C1D8CC0AD2B000420010108032000010520010111110520010111150907060208112D020D020320000205000111250D042001021C060001114111290400001141080002112D1141114103200008042001081C0500010D1125052002011C1C0420011C1C0320000D0C070712211231123108020D0204200012310420011C0811070C123112310202080D0202020211250203061125040001020D042001010D0507030808020807041231123108021707150D0D080D0D0D080D080D0D0D020D020202020202020500020D0D0D0400010D0D08B77A5C561934E0890306122102060D0920030111251129112505200101110804200011250520010112350520010112390800030D123112310D0801000800000000001E01000100540216577261704E6F6E457863657074696F6E5468726F77730108010007010000000008010002000000000000000000004777F26600000000020000001C010000802D0000800F000052534453AC782BAD578667419D8E57DB13DCBA4701000000433A5C55736572735C6D65796E69656C615C736F757263655C7265706F735C636C722D786972725C584952525C6F626A5C44656275675C584952522E7064620000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000C42E00000000000000000000DE2E0000002000000000000000000000000000000000000000000000D02E0000000000000000000000005F436F72446C6C4D61696E006D73636F7265652E646C6C0000000000FF250020001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001001000000018000080000000000000000000000000000001000100000030000080000000000000000000000000000001000000000048000000584000003C02000000000000000000003C0234000000560053005F00560045005200530049004F004E005F0049004E0046004F0000000000BD04EFFE00000100000000000000000000000000000000003F000000000000000400000002000000000000000000000000000000440000000100560061007200460069006C00650049006E0066006F00000000002400040000005400720061006E0073006C006100740069006F006E00000000000000B0049C010000010053007400720069006E006700460069006C00650049006E0066006F0000007801000001003000300030003000300034006200300000002C0002000100460069006C0065004400650073006300720069007000740069006F006E000000000020000000300008000100460069006C006500560065007200730069006F006E000000000030002E0030002E0030002E003000000032000900010049006E007400650072006E0061006C004E0061006D006500000058004900520052002E0064006C006C00000000002800020001004C006500670061006C0043006F0070007900720069006700680074000000200000003A00090001004F0072006900670069006E0061006C00460069006C0065006E0061006D006500000058004900520052002E0064006C006C0000000000340008000100500072006F006400750063007400560065007200730069006F006E00000030002E0030002E0030002E003000000038000800010041007300730065006D0062006C0079002000560065007200730069006F006E00000030002E0030002E0030002E003000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002000000C000000F03E00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000 

SET @hash = (SELECT TOP 1 hash FROM sys.trusted_assemblies WHERE description = 'AssemblyXirr')
IF @hash IS NOT NULL EXEC sp_drop_trusted_assembly @hash
DROP AGGREGATE IF EXISTS dbo.XIRR
DROP ASSEMBLY IF EXISTS AssemblyXirr

SET @hash = HASHBYTES('SHA2_512', @clrBinary)
EXEC sp_add_trusted_assembly @hash, N'AssemblyXirr'
CREATE ASSEMBLY AssemblyXirr AUTHORIZATION [dbo] FROM @clrBinary WITH PERMISSION_SET = UNSAFE;

EXEC ('CREATE AGGREGATE [dbo].[XIRR] (@values [datetime], @dates [float], @guess [float]) RETURNS[float] EXTERNAL NAME [PV_XIRR].[XIRR]')
