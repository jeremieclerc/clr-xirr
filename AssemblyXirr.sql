IF (SELECT TOP 1 value FROM sys.configurations WHERE name = 'clr enabled') != 1
BEGIN
    EXEC sp_configure 'clr enabled', 1
    RECONFIGURE
END
DECLARE @sql nvarchar(MAX), @hash varbinary(64)
DECLARE @clrBinary varbinary(MAX) = 0x4D5A90000300000004000000FFFF0000B800000000000000400000000000000000000000000000000000000000000000000000000000000000000000800000000E1FBA0E00B409CD21B8014CCD21546869732070726F6772616D2063616E6E6F742062652072756E20696E20444F53206D6F64652E0D0D0A2400000000000000504500004C0103007483F5660000000000000000E00022200B013000001400000006000000000000CA320000002000000040000000000010002000000002000004000000000000000600000000000000008000000002000000000000030060850000100000100000000010000010000000000000100000000000000000000000783200004F000000004000009802000000000000000000000000000000000000006000000C000000403100001C0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000200000080000000000000000000000082000004800000000000000000000002E74657874000000D0120000002000000014000000020000000000000000000000000000200000602E7273726300000098020000004000000004000000160000000000000000000000000000400000402E72656C6F6300000C0000000060000000020000001A00000000000000000000000000004000004200000000000000000000000000000000AC3200000000000048000000020005008C280000B40800000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000720002730500000A7D0100000402239A9999999999B93F7D020000042A00000013300400EC00000001000011000F02280600000A2D2E0F01280700000A2D250F01230000000000000000280800000A8C0A000001FE160A0000016F0900000A16FE012B01160A06398E0000000004280A00000A280B00000A280C00000A0C1202280D00000A0B027B01000004078C120000016F0E00000A15FE010D092C20027B01000004078C120000010F01280F00000A8C130000016F1000000A002B3B00027B01000004078C120000016F1100000AA5130000011304027B01000004078C1200000111040F01280F00000A588C130000016F1200000A0000000F03280700000A16FE01130511052C0D020F03280F00000A7D020000042A13300500C5000000020000110002037B020000047D02000004037B010000040A066F1300000A0B066F1400000A0C160D388900000000027B0100000407096F1500000A6F0E00000A15FE01130411042C26027B0100000407096F1500000A08096F1500000AA5130000018C130000016F1000000A002B4200027B0100000407096F1500000A6F1100000AA5130000011305027B0100000407096F1500000A110508096F1500000AA513000001588C130000016F1200000A0000000917580D09066F1600000AFE04130611063A65FFFFFF2A00000013300300C90000000300001100027B010000046F1300000A0A027B010000046F1400000A0B170C170D1613042B48000711046F1500000AA513000001230000000000000000FE02130611062C02160C0711046F1500000AA513000001230000000000000000FE04130711072C02160D110417581304001104076F1700000A2F050809602B0116130811082DA2080960130911092C0A007E1800000A130A2B33000706027B02000004280700000613051105281900000A130B110B2C0A007E1800000A130A2B0C001105731A00000A130A2B00110A2A0000001330030054000000040000110002036F1B00000A7D0200000402730500000A7D01000004036F1C00000A0A160B2B2800027B01000004036F1C00000A8C12000001036F1B00000A8C130000016F1000000A00000717580B0706FE040C082DD02A133003007B000000050000110003027B020000046F1D00000A0003027B010000046F1600000A6F1E00000A00027B010000046F1300000A0A027B010000046F1400000A0B160C2B2C000306086F1500000AA5120000016F1E00000A000307086F1500000AA5130000016F1D00000A00000817580C08027B010000046F1600000AFE040D092DC22A0013300600FD0100000600001100040A238DEDB5A0F7C6B03E0B1F640C2300000000000000000D230000000000000000130423CB1A50CAFFFFEFBF130516130638A7010000002300000000000000000D230000000000000000130416130838BC000000000311086F1500000AA51200000103166F1500000AA512000001596C230000000000D076405B13090623000000000000F03F58130A110A230000000000000000FE0316FE01130C110C2C110023000000000000F8FF130D3848010000110A1109281F00000A130B110B230000000000000000FE01130E110E2C0D0023BBBDD7D9DF7CDB3D130B00090211086F1500000AA513000001110B5B580D110411090211086F1500000AA5130000015A110B110A5A5B591304001108175813081108026F1700000AFE04130F110F3A31FFFFFF09282000000A07FE04131011102C090006130D38BD0000001104230000000000000000FE01131111112C35000203121212132809000006131411142C15000203111211130708280A000006130D38830000000023000000000000F8FF130D2B75060911045B5913071107281900000A2D091107282100000A2B0117131511152C0E0023000000000000F8FF130D2B4611071105FE0316FE01131611162C1200061105582300000000000000405B13070011070A11061758130600110608FE04131711173A4BFEFFFF23000000000000F8FF130D2B00110D2A00000013300300C100000007000011002300000000000000000A0423000000000000F03F580B07230000000000000000FE0316FE010C082C100023000000000000F8FF0D38850000001613042B6C000311046F1500000AA51200000103166F1500000AA512000001596C230000000000D076405B1305071105281F00000A13061106230000000000000000FE01130711072C0D0023BBBDD7D9DF7CDB3D130600060211046F1500000AA51300000111065B580A001104175813041104026F1700000AFE04130811082D84060D2B00092A00000013300300BD00000008000011000423CB1A50CAFFFFEFBF5705230000000000002440570203044F28080000060A0203054F28080000060B06281900000A2D0807281900000A2B01170C082C0500160D2B7606075A230000000000000000FE04130411042C0500170D2B5D1613052B480005054F23000000000000244058570203054F28080000060B07281900000A130611062C03002B1A06075A230000000000000000FE04130711072C0500170D2B170011051758130511051F64FE04130811082DAC160D2B00092A00000013300300DC000000090000110002030428080000060A02030528080000060B06281900000A2D0807281900000A2B01170D092C110023000000000000F8FF130438A000000006075A230000000000000000FE02130511052C0E0023000000000000F8FF13042B7E2300000000000000000C1613062B5E000405582300000000000000405B0C020308280800000613071107282000000A0E04FE04130811082C06000813042B3F1107065A230000000000000000FE04130911092C0A0008100311070B002B080008100211070A000011061758130611060E05FE04130A110A2D960813042B0011042A42534A4201000100000000000C00000076342E302E33303331390000000005006C00000054030000237E0000C00300005403000023537472696E67730000000014070000040000002355530018070000100000002347554944000000280700008C01000023426C6F620000000000000002000001571702000902000000FA013300160000010000001500000003000000020000000A0000001600000001000000210000000400000009000000010000000200000001000000000053010100000000000600F5002A02060015012A020600C00017020F004A0200000A00C302E3010A00D400E301060086007D010A003D01E30106000A0390020A00700059020A007A005902060084017D010600040390020600C9011A000600D6011A000600CA027D0106007D007D01060005007D01060073007D0106009C01900206004E017D01000000000B00000000000100010009211000240000001D000100010082011000FE0100004100030007000600A902F7000600A302FB005020000000008600F502060001007020000000008600A000FE00010068210000000086005F00080104003C22000000008600AB000E010500142300000000E601560013010500742300000000E601BA0019010600FC2300000000960029001F010700082600000000910036001F010A00D826000000009100D10228010D00A427000000009100A80134011100000001007402000002006E0200000300A30200000100C301000001001102000001002F0300000100740200000200BE0200000300A30200000100740200000200BE0200000300B50000000100740200000200BE0202000300900002000400980000000100740200000200BE020000030090000000040098000000050067010000060082020200210009000D02010011000D02060019000D020A0031000D02100049000D02060059005C01200051005C0120005100DD02240081007B022A005900E9022F0089003103360089008D013B006100B502440049003B034800510033014D0049005B00510049006B01570049007401510049002203690049001503690069006B016E004900FA024400A100FA02440051006201850099001400890051000D028E00710065004D007100010044007900BA008E007900BA000100A9002D03BD00A9001302C3009900460389002E000B0040012E00130049012E001B00680143002300710116005C00730093009900A200C800D400E00004800000000000000000000000000000000024000000040000000000000000000000EE004D0000000000040000000000000000000000EE0041000000000003000200000000000052656164496E743332003C4D6F64756C653E0049734E614E0053797374656D2E494F00584952520063616C63756C61746549525200436F6D707574654E50560053797374656D2E44617461006D73636F726C6962005265616400416464004D657267650052656164446F75626C650053716C446F75626C650053716C4461746554696D650056616C756554797065006D696E52617465006D61785261746500416363756D756C617465005465726D696E61746500726174650057726974650044656275676761626C654174747269627574650053716C55736572446566696E656441676772656761746541747472696275746500436F6D70696C6174696F6E52656C61786174696F6E734174747269627574650052756E74696D65436F6D7061746962696C697479417474726962757465006765745F56616C7565004942696E61727953657269616C697A65004D61746800584952522E646C6C006765745F49734E756C6C00746F6C006765745F4974656D007365745F4974656D0053797374656D0054696D655370616E006F705F5375627472616374696F6E0049436F6C6C656374696F6E0043616C63756C6174654952525573696E67426973656374696F6E0047726F75700042696E6172795265616465720042696E617279577269746572004D6963726F736F66742E53716C5365727665722E536572766572005869727243616C63756C61746F72002E63746F72004162730053797374656D2E446961676E6F73746963730053797374656D2E52756E74696D652E436F6D70696C6572536572766963657300446562756767696E674D6F6465730053797374656D2E446174612E53716C54797065730064617465730076616C75657300457175616C73006D6178497465726174696F6E730053797374656D2E436F6C6C656374696F6E7300677565737300697272456C656D656E7473006765745F44617973006461797300466F726D6174004F626A6563740046696E64427261636B6574006F705F496D706C69636974006F705F4578706C6963697400496E6974006765745F436F756E7400494C69737400536F727465644C6973740047657456616C75654C697374004765744B65794C69737400506F77006765745F546F64617900496E6465784F664B6579004973496E66696E6974790000000000000000A969FAD00DE77048BA19036AED3D1FA60004200101080320000105200101111105200101111509070602081131020D020320000205000111290D042001021C0600011145112D040000114508000211311145114503200008042001081C0320000D052002011C1C0420011C1C0C070712251235123508020D0204200012350420011C0811070C123512350202080D0202020211290203061129040001020D042001010D0507030808020807041235123508021A07180D0D080D0D0D080D080D0D0D020D020202020D0D020202020500020D0D0D0400010D0D0B07090D0D020D080D0D02020B07090D0D020202080202020D070B0D0D0D020D02080D02020208B77A5C561934E0890306122502060D092003011129112D1129052001011108042000112905200101123905200101123D0800030D123512350D0B00040212351235100D100D0B00060D123512350D0D0D080801000800000000001E01000100540216577261704E6F6E457863657074696F6E5468726F7773010801000701000000001A010002000000010054080B4D61784279746553697A65FFFFFFFF000000007483F56600000000020000001C0100005C3100005C13000052534453A943D4721925C44DB72863D7AC9A91F901000000433A5C55736572735C6D65796E69656C615C736F757263655C7265706F735C636C722D786972725C584952525C6F626A5C44656275675C584952522E7064620000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000A03200000000000000000000BA320000002000000000000000000000000000000000000000000000AC320000000000000000000000005F436F72446C6C4D61696E006D73636F7265652E646C6C0000000000FF250020001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001001000000018000080000000000000000000000000000001000100000030000080000000000000000000000000000001000000000048000000584000003C02000000000000000000003C0234000000560053005F00560045005200530049004F004E005F0049004E0046004F0000000000BD04EFFE00000100000000000000000000000000000000003F000000000000000400000002000000000000000000000000000000440000000100560061007200460069006C00650049006E0066006F00000000002400040000005400720061006E0073006C006100740069006F006E00000000000000B0049C010000010053007400720069006E006700460069006C00650049006E0066006F0000007801000001003000300030003000300034006200300000002C0002000100460069006C0065004400650073006300720069007000740069006F006E000000000020000000300008000100460069006C006500560065007200730069006F006E000000000030002E0030002E0030002E003000000032000900010049006E007400650072006E0061006C004E0061006D006500000058004900520052002E0064006C006C00000000002800020001004C006500670061006C0043006F0070007900720069006700680074000000200000003A00090001004F0072006900670069006E0061006C00460069006C0065006E0061006D006500000058004900520052002E0064006C006C0000000000340008000100500072006F006400750063007400560065007200730069006F006E00000030002E0030002E0030002E003000000038000800010041007300730065006D0062006C0079002000560065007200730069006F006E00000030002E0030002E0030002E003000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003000000C000000CC3200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000 

SET @hash = (SELECT TOP 1 hash FROM sys.trusted_assemblies WHERE description = 'AssemblyXirr')
IF @hash IS NOT NULL EXEC sp_drop_trusted_assembly @hash
DROP AGGREGATE IF EXISTS dbo.XIRR
DROP ASSEMBLY IF EXISTS AssemblyXirr

SET @hash = HASHBYTES('SHA2_512', @clrBinary)
EXEC sp_add_trusted_assembly @hash, N'AssemblyXirr'
CREATE ASSEMBLY AssemblyXirr AUTHORIZATION [dbo] FROM @clrBinary WITH PERMISSION_SET = UNSAFE;

EXEC ('CREATE AGGREGATE [dbo].[XIRR] (@values [float], @dates [datetime], @guess [float]) RETURNS[float] EXTERNAL NAME [AssemblyXirr].[XIRR]')
